#include <iostream>
#include <fstream>
#include <stdint.h>
#include <vector>
#include <cstring>

#define IMAGE_SIZE 128
#define PATCH_SIZE 32

const uint8_t trainImage[2048] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 255, 255, 255, 255, 255, 255, 255, 255, 255, 128, 0, 0, 0, 0, 0, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 254, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 252, 127, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 248, 127, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 240, 127, 227, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 226, 127, 128, 255, 255, 255, 128, 255, 255, 224, 0, 0, 0, 0, 0, 7, 230, 127, 0, 127, 255, 255, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 192, 63, 0, 63, 255, 254, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 240, 127, 0, 63, 255, 254, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 252, 127, 0, 127, 255, 255, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 252, 120, 0, 15, 255, 253, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 224, 0, 7, 255, 224, 0, 0, 0, 0, 0, 7, 251, 192, 0, 3, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 240, 192, 0, 1, 255, 192, 0, 1, 255, 224, 0, 0, 0, 0, 0, 7, 240, 192, 0, 1, 255, 192, 0, 1, 255, 224, 0, 0, 0, 0, 0, 7, 192, 32, 0, 3, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 128, 56, 98, 7, 255, 240, 38, 7, 255, 224, 0, 0, 0, 0, 0, 7, 192, 63, 195, 255, 255, 255, 195, 255, 255, 224, 0, 0, 0, 0, 0, 7, 249, 255, 193, 255, 255, 255, 129, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 193, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 129, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 15, 255, 255, 131, 255, 255, 255, 129, 255, 143, 224, 0, 0, 0, 0, 0, 15, 255, 249, 199, 255, 255, 255, 131, 254, 3, 224, 0, 0, 0, 0, 0, 15, 255, 192, 68, 15, 255, 224, 70, 12, 1, 224, 0, 0, 0, 0, 0, 15, 255, 128, 0, 7, 255, 192, 0, 4, 1, 224, 0, 0, 0, 0, 0, 15, 255, 128, 0, 3, 255, 128, 0, 3, 7, 224, 0, 0, 0, 0, 0, 15, 255, 128, 0, 3, 255, 128, 0, 3, 7, 224, 0, 0, 0, 0, 0, 15, 255, 192, 0, 7, 255, 128, 0, 3, 143, 224, 0, 0, 0, 0, 0, 15, 255, 224, 0, 7, 255, 192, 0, 7, 255, 224, 0, 0, 0, 0, 0, 15, 255, 254, 0, 63, 255, 240, 0, 14, 63, 224, 0, 0, 0, 0, 0, 15, 255, 252, 0, 255, 255, 254, 0, 254, 31, 224, 0, 0, 0, 0, 0, 15, 255, 252, 0, 127, 255, 252, 0, 127, 63, 224, 0, 0, 0, 0, 0, 15, 255, 252, 0, 255, 255, 252, 0, 124, 1, 224, 0, 0, 0, 0, 0, 15, 255, 254, 0, 255, 255, 254, 0, 127, 49, 224, 0, 0, 0, 0, 0, 15, 255, 255, 1, 255, 255, 254, 0, 255, 35, 224, 0, 0, 0, 0, 0, 15, 255, 255, 207, 255, 255, 255, 131, 255, 7, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 15, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 31, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 63, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 15, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 0, 0, 127, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 127, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

// Unpack the bits into a 2D array of 0/1 pixels
void unpackImage(const uint8_t* packed, int rows, int cols, uint8_t image[IMAGE_SIZE][IMAGE_SIZE]) {
    for (int i = 0; i < rows * cols; i++) {
        int byteIndex = i / 8;
        int bitIndex = 7 - (i % 8);
        image[i / cols][i % cols] = (packed[byteIndex] >> bitIndex) & 1;
    }
}

// Crop the top-left corner of the largest white region
void cropCard(uint8_t image[IMAGE_SIZE][IMAGE_SIZE], uint8_t patch[PATCH_SIZE][PATCH_SIZE]) {
    int minX = IMAGE_SIZE, minY = IMAGE_SIZE;
    int maxX = 0, maxY = 0;

    // Find bounding box of white pixels
    for (int y = 0; y < IMAGE_SIZE; y++) {
        for (int x = 0; x < IMAGE_SIZE; x++) {
            if (image[y][x]) {
                if (x < minX) minX = x;
                if (y < minY) minY = y;
                if (x > maxX) maxX = x;
                if (y > maxY) maxY = y;
            }
        }
    }

    int boxWidth = maxX - minX + 1;
    int boxHeight = maxY - minY + 1;

    int cropWidth = std::min(PATCH_SIZE, boxWidth);
    int cropHeight = std::min(PATCH_SIZE, boxHeight);

    // Copy white region into patch
    for (int y = 0; y < cropHeight; y++) {
        for (int x = 0; x < cropWidth; x++) {
            patch[y][x] = image[minY + y][minX + x];
        }
    }

    // Fill remaining patch area with black
    for (int y = cropHeight; y < PATCH_SIZE; y++)
        for (int x = 0; x < PATCH_SIZE; x++)
            patch[y][x] = 0;
    for (int y = 0; y < cropHeight; y++)
        for (int x = cropWidth; x < PATCH_SIZE; x++)
            patch[y][x] = 0;
}

// Save a PBM file for visualization
void savePBM(const char* filename, uint8_t* image, int width, int height) {
    std::ofstream out(filename, std::ios::binary);
    out << "P4\n" << width << " " << height << "\n";

    int nBytes = (width * height + 7) / 8;
    std::vector<uint8_t> packed(nBytes, 0);

    for (int i = 0; i < width * height; i++) {
        int byteIndex = i / 8;
        int bitIndex = 7 - (i % 8);
        if (image[i]) packed[byteIndex] |= (1 << bitIndex);
    }

    out.write((const char*)packed.data(), packed.size());
    out.close();
}

int main() {
    uint8_t unpacked[IMAGE_SIZE][IMAGE_SIZE];
    unpackImage(trainImage, IMAGE_SIZE, IMAGE_SIZE, unpacked);

    uint8_t patch[PATCH_SIZE][PATCH_SIZE];
    cropCard(unpacked, patch);

    // Flatten patch for PBM saving
    uint8_t flatPatch[PATCH_SIZE * PATCH_SIZE];
    for (int i = 0; i < PATCH_SIZE; i++)
        for (int j = 0; j < PATCH_SIZE; j++)
            flatPatch[i * PATCH_SIZE + j] = patch[i][j];

    // Flatten original image for PBM
    uint8_t flatOriginal[IMAGE_SIZE * IMAGE_SIZE];
    for (int i = 0; i < IMAGE_SIZE; i++)
        for (int j = 0; j < IMAGE_SIZE; j++)
            flatOriginal[i * IMAGE_SIZE + j] = unpacked[i][j];

    savePBM("original.pbm", flatOriginal, IMAGE_SIZE, IMAGE_SIZE);
    savePBM("patch.pbm", flatPatch, PATCH_SIZE, PATCH_SIZE);

    std::cout << "Saved original.pbm and patch.pbm\n";
}