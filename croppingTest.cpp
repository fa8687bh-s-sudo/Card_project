#include <iostream>
#include <fstream>
#include <stdint.h>
#include <vector>
#include <cstring>
#include <algorithm>

#define IMAGE_SIZE 128
#define PATCH_SIZE 32

const uint8_t trainImage[2048] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 255, 255, 255, 255, 255, 255, 255, 255, 255, 128, 0, 0, 0, 0, 0, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 216, 127, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 219, 63, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 255, 255, 255, 255, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 128, 255, 255, 255, 1, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 0, 127, 255, 254, 0, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 0, 127, 255, 254, 0, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 0, 127, 255, 254, 0, 255, 255, 192, 0, 0, 0, 0, 0, 3, 211, 63, 0, 127, 255, 254, 0, 255, 255, 192, 0, 0, 0, 0, 0, 3, 216, 120, 0, 31, 255, 248, 0, 31, 255, 192, 0, 0, 0, 0, 0, 3, 255, 224, 0, 7, 255, 224, 0, 7, 255, 192, 0, 0, 0, 0, 0, 3, 255, 224, 0, 3, 255, 192, 0, 7, 255, 192, 0, 0, 0, 0, 0, 3, 241, 192, 0, 3, 129, 192, 0, 3, 255, 192, 0, 0, 0, 0, 0, 3, 240, 224, 0, 3, 0, 192, 0, 7, 255, 192, 0, 0, 0, 0, 0, 3, 192, 32, 52, 6, 0, 96, 36, 7, 255, 192, 0, 0, 0, 0, 0, 3, 128, 56, 99, 14, 0, 120, 199, 31, 255, 192, 0, 0, 0, 0, 0, 3, 192, 127, 193, 255, 0, 127, 195, 255, 255, 192, 0, 0, 0, 0, 0, 3, 251, 255, 193, 255, 0, 255, 131, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 255, 240, 0, 15, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 255, 224, 0, 3, 255, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 227, 192, 0, 3, 199, 255, 255, 192, 0, 0, 0, 0, 0, 3, 255, 255, 128, 192, 0, 3, 1, 255, 255, 224, 0, 0, 0, 0, 0, 3, 255, 255, 0, 96, 4, 2, 0, 255, 255, 224, 0, 0, 0, 0, 0, 3, 255, 255, 0, 112, 38, 14, 0, 127, 255, 224, 0, 0, 0, 0, 0, 3, 255, 255, 0, 127, 227, 254, 0, 127, 255, 224, 0, 0, 0, 0, 0, 3, 255, 255, 0, 127, 193, 255, 0, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 248, 0, 15, 255, 248, 0, 31, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 224, 0, 7, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 192, 0, 1, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 20, 3, 255, 224, 36, 7, 255, 224, 0, 0, 0, 0, 0, 7, 255, 248, 99, 15, 255, 248, 231, 63, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 193, 255, 255, 255, 195, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 193, 255, 255, 255, 129, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 195, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 193, 255, 255, 255, 195, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 227, 255, 255, 255, 227, 191, 255, 224, 0, 0, 0, 0, 0, 7, 255, 240, 34, 7, 255, 224, 36, 7, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 20, 3, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 192, 0, 1, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 192, 0, 1, 255, 192, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 224, 0, 3, 255, 224, 0, 0, 0, 0, 0, 7, 255, 240, 0, 7, 255, 240, 0, 15, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 128, 255, 193, 255, 0, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 0, 127, 195, 254, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 255, 254, 0, 120, 99, 14, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 255, 254, 0, 96, 36, 2, 0, 127, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 0, 64, 0, 3, 0, 255, 255, 224, 0, 0, 0, 0, 0, 7, 255, 255, 128, 192, 0, 1, 193, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 192, 0, 3, 255, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 224, 0, 3, 255, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 240, 0, 15, 255, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 193, 255, 0, 127, 193, 255, 239, 240, 0, 0, 0, 0, 0, 7, 255, 255, 195, 255, 0, 127, 227, 254, 0, 240, 0, 0, 0, 0, 0, 7, 255, 248, 99, 14, 0, 112, 98, 6, 0, 240, 0, 0, 0, 0, 0, 7, 255, 224, 36, 3, 0, 96, 20, 3, 1, 240, 0, 0, 0, 0, 0, 7, 255, 192, 0, 3, 0, 64, 0, 1, 131, 240, 0, 0, 0, 0, 0, 7, 255, 192, 0, 1, 193, 192, 0, 1, 199, 240, 0, 0, 0, 0, 0, 7, 255, 192, 0, 3, 255, 224, 0, 3, 255, 240, 0, 0, 0, 0, 0, 7, 255, 224, 0, 3, 255, 224, 0, 3, 221, 240, 0, 0, 0, 0, 0, 7, 255, 240, 0, 15, 255, 248, 0, 15, 12, 240, 0, 0, 0, 0, 0, 7, 255, 255, 0, 127, 255, 255, 0, 126, 100, 240, 0, 0, 0, 0, 0, 7, 255, 254, 0, 127, 255, 255, 0, 62, 100, 240, 0, 0, 0, 0, 0, 7, 255, 254, 0, 127, 255, 255, 0, 62, 100, 240, 0, 0, 0, 0, 0, 7, 255, 254, 0, 127, 255, 255, 0, 126, 100, 240, 0, 0, 0, 0, 0, 7, 255, 255, 0, 255, 255, 255, 128, 127, 100, 240, 0, 0, 0, 0, 0, 7, 255, 255, 129, 255, 255, 255, 193, 255, 100, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 100, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 4, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 140, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 240, 0, 0, 0, 0, 0, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 224, 0, 0, 0, 0, 0, 3, 255, 255, 255, 255, 255, 255, 255, 255, 252, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

void unpackImage(const uint8_t* packed, int rows, int cols,
                 uint8_t image[IMAGE_SIZE][IMAGE_SIZE]) {
    for (int i = 0; i < rows * cols; i++) {
        int byteIndex = i / 8;
        int bitIndex  = 7 - (i % 8);
        image[i / cols][i % cols] = (packed[byteIndex] >> bitIndex) & 1;
    }
}

struct ComponentBox {
    int minX, minY, maxX, maxY;
    int size;
};

ComponentBox findLargestRegion(uint8_t image[IMAGE_SIZE][IMAGE_SIZE],
                               int targetColor,
                               int minX, int minY, int maxX, int maxY) {
    static uint8_t visited[IMAGE_SIZE][IMAGE_SIZE];
    memset(visited, 0, sizeof(visited));

    ComponentBox best;
    best.size = 0;

    static int stackX[IMAGE_SIZE * IMAGE_SIZE];
    static int stackY[IMAGE_SIZE * IMAGE_SIZE];

    for (int y = minY; y <= maxY; y++) {
        for (int x = minX; x <= maxX; x++) {

            if (image[y][x] != targetColor || visited[y][x])
                continue;

            ComponentBox current;
            current.minX = current.maxX = x;
            current.minY = current.maxY = y;
            current.size = 0;

            int sp = 0;
            stackX[sp] = x;
            stackY[sp] = y;
            sp++;
            visited[y][x] = 1;

            while (sp > 0) {
                sp--;
                int cx = stackX[sp];
                int cy = stackY[sp];

                current.size++;

                if (cx < current.minX) current.minX = cx;
                if (cx > current.maxX) current.maxX = cx;
                if (cy < current.minY) current.minY = cy;
                if (cy > current.maxY) current.maxY = cy;

                const int dx[4] = { 1, -1, 0, 0 };
                const int dy[4] = { 0, 0, 1, -1 };

                for (int i = 0; i < 4; i++) {
                    int nx = cx + dx[i];
                    int ny = cy + dy[i];

                    if (nx < minX || ny < minY || nx > maxX || ny > maxY)
                        continue;

                    if (image[ny][nx] == targetColor && !visited[ny][nx]) {
                        visited[ny][nx] = 1;
                        stackX[sp] = nx;
                        stackY[sp] = ny;
                        sp++;
                    }
                }
            }

            if (current.size > best.size)
                best = current;
        }
    }

    return best;
}

void cropPatch(uint8_t image[IMAGE_SIZE][IMAGE_SIZE],
               ComponentBox box,
               uint8_t patch[PATCH_SIZE][PATCH_SIZE]) {
    for (int y = 0; y < PATCH_SIZE; y++)
        for (int x = 0; x < PATCH_SIZE; x++)
            patch[y][x] = 1;

    int boxWidth  = box.maxX - box.minX + 1;
    int boxHeight = box.maxY - box.minY + 1;

    int cropWidth  = std::min(PATCH_SIZE, boxWidth);
    int cropHeight = std::min(PATCH_SIZE, boxHeight);

    int offsetX = (PATCH_SIZE - cropWidth) / 2;
    int offsetY = (PATCH_SIZE - cropHeight) / 2;

    for (int y = 0; y < cropHeight; y++)
        for (int x = 0; x < cropWidth; x++)
            patch[offsetY + y][offsetX + x] = image[box.minY + y][box.minX + x];
}

void printPatch(uint8_t patch[PATCH_SIZE][PATCH_SIZE]) {
    std::cout << "Patch pixels:\n";
    for (int y = 0; y < PATCH_SIZE; y++) {
        for (int x = 0; x < PATCH_SIZE; x++)
            std::cout << (int)patch[y][x];
        std::cout << "\n";
    }
}

void printCardBox(uint8_t image[IMAGE_SIZE][IMAGE_SIZE], ComponentBox box) {
    std::cout << "CardBox pixels:\n";
    for (int y = box.minY; y <= box.maxY; y++) {
        for (int x = box.minX; x <= box.maxX; x++)
            std::cout << (int)image[y][x];
        std::cout << "\n";
    }
}

int main() {
    uint8_t unpacked[IMAGE_SIZE][IMAGE_SIZE];
    unpackImage(trainImage, IMAGE_SIZE, IMAGE_SIZE, unpacked);

    ComponentBox cardBox = findLargestRegion(unpacked, 1, 0, 0, IMAGE_SIZE - 1, IMAGE_SIZE - 1);
    std::cout << "Card box: (" << cardBox.minX << "," << cardBox.minY << ") - ("
              << cardBox.maxX << "," << cardBox.maxY << ")\n";

    ComponentBox blackBox = findLargestRegion(unpacked, 0,
                                              cardBox.minX, cardBox.minY,
                                              cardBox.maxX, cardBox.maxY);
    std::cout << "Largest black region inside card: (" << blackBox.minX << "," << blackBox.minY
              << ") - (" << blackBox.maxX << "," << blackBox.maxY << ")\n";

    uint8_t patch[PATCH_SIZE][PATCH_SIZE];
    cropPatch(unpacked, blackBox, patch);

    printCardBox(unpacked, cardBox);
    printPatch(patch);

    return 0;
}
